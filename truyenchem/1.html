<!-- (<br>\w+)<br>\s+(<br>\w+)<br>\s+(.+) -->
<!-- {word: "$1", types: "$2", mean: "$3"}, -->

<!DOCTYPE html>
<html>
<head>
  <title>LPTD 1</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-sanitize.js"></script>

  <script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" type="text/css" href="../styles.css">
</head>


<body ng-app="myApp">
    <div ng-controller="ctrl" class="container mt-4">
    <h4 class="mb-4">Stories</h4>

    	<a href="../../index.html" class="mt-2">Home</a>

    	<div class="my-3">
		    <div ng-repeat="u in units"> {{u.title}}
		    	 <a ng-repeat="n in range(u.num, u.num + 1)" ng-click="fetchStory(n-1);"  href=""> {{n}} &nbsp|
		    	</a>
		    </div>
		    <br> 
		    <label> <input class="my-3" type="checkbox" ng-click="isAudioLoop=!isAudioLoop">&nbspAudio loop</label>

		    	<span class="btnShowVi opa">
		        	<button class="btn btn-sm btn-success" ng-click="bShowVi=!bShowVi">{{bShowVi == 0 ? '->Vi' : '->En' }}</button>
		    	</span>

		        <span ng-show="!bShowVi" class="btnEnVi opa">
    				<p><button class="btn btn-sm btn-danger" ng-click="bHiddenWords=!bHiddenWords">{{bHiddenWords == 0 ? '->[..]' : '->[w]' }}</button></p>
    				<p><button class="btn btn-sm btn-danger" ng-show="bHiddenWords" ng-click="fetchStory(storyIdx, false)">[Rs]</button></p>
    			</span>
		 </div>

		<span  class="btnPlay opa">
			<button class="btn btn-sm btn-info" ng-click="playFullSound($index)">{{bPlayingFull ? 'Stop' : 'Play'}}</button>
		</span>

    	<span ng-show="bPlayingFull" class="btnSound opa">
    		<p><button class="btn btn-sm btn-danger" ng-click="pauseSound()">{{bPause ? 'Resume' : 'Pause'}}</button></p>
    		<p><button class="btn btn-sm btn-danger" ng-click="backSound(-5)">-5s</button></p>
    		<p><button class="btn btn-sm btn-danger" ng-click="backSound(5)">+5s</button></p>
    	</span>


		<div class="card mt-4">
		    <div class="card-body">
	          <div class="card-text my-2">
	          	<label class="btn-sm btn-success">{{storyIdx+1}}</label>
	          	<p ng-bind-html="story.enShow" ng-if="!bShowVi && !bHiddenWords"></p>
	          	<p ng-bind-html="story.viShow" ng-if="bShowVi"></p>
	          	<p ng-bind-html="story.en_hidden_words" ng-if="bHiddenWords && !bShowVi"></p>
	        <!--   	
	        	<div class="mt-5"  ng-if="story.voca">
	          		<hr/>
	          		<p ng-bind-html="story.voca"></p>
	          	</div>
	          	 -->
	          	
	          </div> <!-- card-text -->
        	</div> 		<!-- card-body -->
		 </div> <!-- card -->
    </div> <!-- container -->
</body>

<script type="text/javascript">
    var app = angular.module("myApp", ['ngSanitize']);
    app.controller("ctrl", function($scope, $timeout) {

    $scope.stories = [
{
	en: 
	'The Lion and the Rabbit <br>\
A cruel lion lived in the forest. Every day, he killed and ate a lot of animals. The other animals were afraid the lion would kill them all.<br>\
The animals told the lion, "Let‘s make a deal. If you promise to eat only one animal each day, then one of us will come to you every day. Then you don‘t have to hunt and kill us."<br>\
The plan sounded well thought-out to the lion, so he agreed, but he also said, "If you don‘t come every day, I promise to kill all of you the next day!"<br>\
Each day after that, one animal went to the lion so that the lion could eat it. Then, all the other animals were safe.<br>\
Finally, it was the rabbit‘s turn to go to the lion. The rabbit went very slowly that day, so the lion was angry when the rabbit finally arrived.<br>\
The lion angrily asked the rabbit, "Why are you late?" <br>\
"I was hiding from another lion in the forest. That lion said he was the king, so I was afraid."<br>\
The lion told the rabbit, "I am the only king here! Take me to that other lion, and I will kill him. The rabbit replied, "I will be happy to show you where he lives."<br>\
The rabbit led the lion to an old well in the middle of the forest. The well was very deep with water at the bottom.<br>\
The rabbit told the lion, "Look in there. The lion lives at the bottom." <br>\
When the lion looked in the well, he could see his own face in-the water. He thought that was the other lion. Without waiting another moment, the lion jumped into the well to attack the other lion. He never came out.<br>\
All of the other animals in the forest were very pleased with the rabbit‘s clever trick.',
	vi: 
	'Sư tử và Thỏ <br>\
Một con sư tử hung dữ sống trong rừng. Mỗi ngày, nó giết và ăn rất nhiều động vật. Các loài động vật khác sợ rằng sư tử sẽ giết hết chúng.<br>\
Các loài động vật nói với sư tử, "Chúng ta hãy thỏa thuận. Nếu anh hứa chỉ ăn một con vật mỗi ngày, thì một trong số chúng tôi sẽ đến gặp anh mỗi ngày. Khi đó, anh không phải săn đuổi và giết chúng tôi nữa."<br>\
Kế hoạch nghe có vẻ hợp lý với sư tử, nên nó đồng ý, nhưng nó cũng nói, "Nếu anh không đến mỗi ngày, tôi hứa sẽ giết hết các người vào ngày hôm sau!"<br>\
Mỗi ngày sau đó, một con vật đến gặp sư tử để sư tử có thể ăn thịt nó. Sau đó, tất cả các loài động vật khác đều được an toàn.<br>\
Cuối cùng, đến lượt thỏ đến gặp sư tử. Thỏ đi rất chậm vào ngày hôm đó, vì vậy sư tử đã tức giận khi thỏ cuối cùng cũng đến.<br>\
Sư tử tức giận hỏi thỏ, "Tại sao bạn đến muộn? <br>\
"Tôi đang trốn một con sư tử khác trong rừng. Con sư tử đó nói rằng nó là vua, vì vậy tôi sợ."<br>\
Sư tử nói với thỏ, "Tôi là vị vua duy nhất ở đây! Hãy dẫn tôi đến chỗ con sư tử kia, và tôi sẽ giết nó." Thỏ trả lời, "Tôi sẽ rất vui khi chỉ cho bạn nơi nó sống."<br>\
Thỏ dẫn sư tử đến một cái giếng cũ ở giữa rừng. Giếng rất sâu với nước ở dưới đáy.<br>\
Thỏ nói với sư tử, "Hãy nhìn vào đó. Sư tử sống ở dưới đáy." <br>\
Khi sư tử nhìn vào giếng, nó có thể nhìn thấy khuôn mặt của chính mình trong nước. Nó nghĩ rằng đó là con sư tử kia. Không đợi thêm một phút nào nữa, sư tử nhảy xuống giếng để tấn công con sư tử kia. Anh ta không bao giờ ra ngoài.<br>\
Tất cả các loài động vật khác trong rừng đều rất hài lòng với trò lừa bịp thông minh của chú thỏ.',
},
{
	en: 
	'The Laboratory <br>\
Mia‘s father had a laboratory, but she had no idea what was in it. Her dad always closed and locked the door when he went in. She knew that he used it to do projects for work. He never told Mia what these projects were.<br>\
One night, Mia approached the door to the laboratory. She stopped and thought, "I wonder what crazy experiment he is doing now." Suddenly, she heard a loud noise. It sounded like an evil laugh. The noise scared her, so she walked quickly back to her room.<br>\
The next night, her friend Liz came to her house. When Liz arrived, Mia told her about the night before. "Oh, it was terrible," she said. "Why don‘t we see what is in there?" Liz asked. "It will be a fun adventure!"<br>\
Mia felt nervous about going into her father‘s laboratory, but she agreed. <br>\
As always, the door was locked. They waited until Mia‘s father left the laboratory to eat dinner. "He didn‘t lock the door!" Liz said. "Let‘s go."<br>\
The laboratory was dark. The girls walked down the stairs carefully. Mia smelled strange chemicals. What terrible thing was her father creating? Suddenly, they heard an evil laugh. It was even worse than the one Mia heard the night before. What if a monster was going to kill them? Mia had to do something. She shouted for help.<br>\
Mia‘s father ran into the room and turned on the lights. "Oh, no," he said. "You must have learned my secret." "Your monster tried to kill us," Mia said.<br>\
"Monster?" he asked. "You mean this?" He had a pretty doll in his hands. The doll laughed. The laugh didn‘t sound so evil anymore. "I made this for your birthday. I wanted to give it to you then, but you can have it now. I hope you like it!"',
	vi: 
	'Phòng thí nghiệm <br>\
Bố của Mia có một phòng thí nghiệm, nhưng cô bé không biết bên trong có gì. Bố cô bé luôn đóng và khóa cửa khi vào. Cô bé biết rằng ông dùng phòng thí nghiệm để làm dự án cho công việc. Ông chưa bao giờ nói với Mia những dự án đó là gì.<br>\
Một đêm nọ, Mia đến gần cửa phòng thí nghiệm. Cô bé dừng lại và nghĩ, "Không biết ông ấy đang làm thí nghiệm điên rồ gì đây." Đột nhiên, cô bé nghe thấy một tiếng động lớn. Nghe giống như tiếng cười ma quái. Tiếng động đó khiến cô bé sợ hãi, vì vậy cô bé nhanh chóng quay trở lại phòng mình.<br>\
Đêm hôm sau, bạn của cô bé là Liz đến nhà cô bé. Khi Liz đến, Mia kể cho cô bé nghe về đêm hôm trước. "Ồ, kinh khủng thật," cô bé nói. "Sao chúng ta không xem bên trong có gì nhỉ?" Liz hỏi. "Sẽ là một cuộc phiêu lưu thú vị!"<br>\
Mia cảm thấy lo lắng khi vào phòng thí nghiệm của bố mình, nhưng cô bé đồng ý. <br>\
Như thường lệ, cửa đã bị khóa. Họ đợi cho đến khi bố của Mia rời khỏi phòng thí nghiệm để ăn tối. "Bố ấy không khóa cửa!" Liz nói. "Đi thôi."<br>\
Phòng thí nghiệm tối om. Các cô gái cẩn thận bước xuống cầu thang. Mia ngửi thấy mùi hóa chất lạ. Cha cô đang tạo ra thứ gì kinh khủng thế? Đột nhiên, họ nghe thấy tiếng cười độc ác. Thậm chí còn tệ hơn tiếng cười mà Mia nghe thấy đêm hôm trước. Nếu một con quái vật định giết họ thì sao? Mia phải làm gì đó. Cô hét lên cầu cứu.<br>\
Cha của Mia chạy vào phòng và bật đèn. "Ồ, không," ông nói. "Con hẳn đã biết được bí mật của cha." "Con quái vật của con đã cố giết chúng ta," Mia nói.<br>\
"Quái vật?" ông hỏi. "Ý con là cái này à?" Ông cầm một con búp bê xinh xắn trên tay. Con búp bê cười. Tiếng cười không còn nghe có vẻ độc ác nữa. "Cha đã làm cái này cho sinh nhật con. Cha đã muốn tặng con lúc đó, nhưng giờ con có thể lấy nó. Cha hy vọng con thích nó!"',
	voca:
	''
}
	   ];



	$scope.range = function(min, max, step) {
	    step = step || 1;
	    var input = [];
	    for (var i = min; i <= max; i += step) {
	        input.push(i);
	    }
	    return input;
	};

	 $scope.storyIdx = 0;
	 $scope.bPlayingSentence = false;

	 $scope.bPlayingFull = false;
	 $scope.bPause = false;
	 $scope.bShowVi = 0;
	 $scope.bHiddenWords = 0;
	 $scope.audio;
	 $scope.currentTime = 0;
	 $scope.isAudioLoop = false;

    
	$scope.units = [
		 {'title':"", 'num': 1},
		// {'title':"Science and Technology", 'num':6},
		// {'title':"Art and Culture", 'num': 11},
		// {'title':"Leisure and Entertainment", 'num':16},
		// {'title':"School and Family", 'num':21},
		// {'title':"People and Work", 'num':26},
		// {'title':"Sports and Health", 'num':31},
		// {'title':"Travel and Transport", 'num':36},
	];


	$scope.resetFlag = function () {
		$scope.bPlayingFull = false;
		$scope.bPause = false;
		$scope.bShowVi = 0;
		$scope.bHiddenWords = 0;
	}	

	$scope.backSound = function (sec) {
		$scope.audio.currentTime = $scope.audio.currentTime + sec;
	}

	$scope.resetAudioBtnUI = function()
	{
		$scope.bPause=false;
        $scope.bPlayingFull=false;
        if ($scope.isAudioLoop)
        {
        	$scope.playFullSound($scope.storyIdx);
        }
        $scope.$apply();
	}

	$scope.playFullSound = function (index) {
		if ($scope.bPlayingFull)
		{
			$scope.stopSound();
			$scope.bPause=false;
		}
	  	else
	  	{
	  		$scope.audio = new Audio($scope.storyIdx + '.mp3');
		    $scope.audio.loop = false;
		    $scope.audio.play();

 			$scope.audio.addEventListener("ended", function(){
			   $scope.resetAudioBtnUI();
			});

		    $scope.bPlayingFull = true;
	  	}
	}

	$scope.pauseSound = function () {
		if (!$scope.audio) return;
		$scope.bPause = !$scope.bPause;
		if ($scope.bPause)
	    {
	    	$scope.audio.pause();
	    	$scope.currentTime = $scope.audio.currentTime;
	    }
	    else
	    {
	    	$scope.audio.currentTime = $scope.currentTime;
	    	$scope.audio.play();
	    }
	}

	$scope.stopSound = function () {
		if (!$scope.audio) return;
		 $scope.audio.pause();
		 $scope.audio.currentTime = 0;
		 $scope.currentTime = 0;
		 $scope.bPlayingFull = false;
		 $scope.bPlayingSentence = false;
	};

	$scope.fetchStory = function (idx, reset=true) {

		// when click 1.2.3..40
		if (reset==true) 
		{
			$scope.resetFlag();
			$scope.stopSound();
		}
		
		
		$scope.storyIdx = idx;
		$scope.story = $scope.stories[idx];

		// show to website
		// $scope.story.en|vi ~ origin [not edit]
		$scope.story.enShow = '';
		$scope.story.viShow = '';
		$scope.story.en_hidden_words = '';

		// bold title
		var titleEn = $scope.story.en.split('<br>')[0];
		$scope.story.enShow = $scope.story.en.replace(titleEn, '<b>' + titleEn + '</b>');

		var titleVi = $scope.story.vi.split('<br>')[0];
		$scope.story.viShow = $scope.story.vi.replace(titleVi, '<b>' + titleVi + '</b>');

		//
		$scope.story.en_hidden_words = $scope.story.en;
		console.log('=-==========================');
		var words = $scope.story.en.match(/\b(\w+)\b/g);
		var _wPosArr = [];   // index in Arr
		var kDot = "";
		var kSpace = "";
		for (let i = 0; i < words.length; i++) {
		  	var word = words[i];
		  	if (validateWord(word)) 
		  	{
  				var rd = Math.floor(Math.random() * 11);   // integer from 0 to 12
  				if (rd % 5 == 0) {
  					var _w = kSpace + word + kSpace;
  					var idxOf = $scope.story.en.indexOf(_w);
  					var obj = {'w': _w, "idx": idxOf}

  					_wPosArr.push(obj);
  				//	console.log(_w);
  					
  					kDot = kSpace + word.replace(/./g, ".") + kSpace;
  				//	console.log(kDot);
  					var s = $scope.story.en_hidden_words;

  					let firstPart = s.substr(0, idxOf);
				    let lastPart = s.substr(idxOf + kDot.length);
				    let newString = firstPart + kDot + lastPart;

  					$scope.story.en_hidden_words = newString;
  				}
		  	}
		} // for
		titleEn = $scope.story.en_hidden_words.split('<br>')[0];
		$scope.story.en_hidden_words = $scope.story.en_hidden_words.replace(titleEn, '<b>' + titleEn + '</b>');
	}

	function validateWord(word) 
	{	
		word = word.trim();
		if (word.length < 4) return false;
		let arr = ['<br>','<b>','</b>', '!','.',',',"'",'’','unit','there','this','that','those'];
		for (var i = 0; i < arr.length; i++) {
			bList = arr[i];
			if (word.toLowerCase().indexOf(bList) >= 0) return false;
		}
		return true;
	}

	$scope.fetchStory(0, false);

    });

</script>
</html>
